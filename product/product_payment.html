<!doctype html>
<html lang="ko">
	<head>
		<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
		<link rel="stylesheet" href="../common/styles.css" />
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>í”„ë¡œì íŠ¸ í›„ì›í•˜ê¸°</title>
		<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
		<style>
			/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
			.wrapper {
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
			}
			.container {
				flex: 2;
			}
			.container_1 {
				flex: 1;
				margin-top: 778px;
			}
			.section {
				margin-bottom: 50px;
			}
			.section-title {
				font-size: 18px;
				font-weight: bold;
				margin-bottom: 10px;
				border-bottom: 2px solid #eee;
				padding-bottom: 5px;
			}
			.product-image {
				width: 100%;
				height: auto;
				border-radius: 8px;
				margin-bottom: 10px;
			}
			.info-text {
				margin: 5px 0;
			}
			p {
				font-size: 1rem;
			}
			input,
			textarea {
				padding: 10px;
				margin-top: 8px;
				border: 1px solid #ccc;
				border-radius: 6px;
				font-size: 14px;
			}
			.checkbox-group {
				display: flex;
				flex-direction: column;
				align-items: flex-start;
				gap: 10px;
			}

			.checkbox-group label {
				display: flex;
				align-items: center;
				gap: 8px;
				font-size: 14px;
			}
			#postcode {
				width: 70%;
			}
			#address {
				width: 70%;
			}
			@media (min-width: 1024px) {
				.wrapper {
					box-sizing: content-box;
					width: 1150px;
				}
				.container {
					box-sizing: content-box;
					width: 500px;
					padding: 0 100px 0 160px;
				}
				.container_1 {
					box-sizing: content-box;
					margin-top: 800px;
				}
				.section1 {
					height: 450px;
				}
			}
			@media (min-width: 750px) and (max-width: 1023px) {
				.wrapper {
					box-sizing: content-box;
					width: 650px;
				}
				.container {
					box-sizing: content-box;
					width: 500px;
					padding: 10px 30px 30px 80px;
				}
				.container_1 {
					box-sizing: content-box;
					width: 400px;
					margin-top: 568px;
				}
			}
		</style>
	</head>
	<body>
		<div class="page-container">
			<main class="page-content">
				<!-- ë³¸ë¬¸ ë‚´ìš© -->

				<div class="wrapper">
					<div class="container">
						<!-- ìƒí’ˆ ìš”ì•½ -->
						<div class="section">
							<div class="section-title">ìƒí’ˆ ìš”ì•½</div>
							<img id="productImage" src="" alt="ì„ íƒí•œ ìƒí’ˆ ì´ë¯¸ì§€" class="product-image" />
							<div class="info-text"><strong>ìƒí’ˆëª…:</strong> <span id="productTitle"></span></div>
						</div>

						<!-- ìƒí’ˆ êµ¬ì„± ì •ë³´ -->
						<div class="section">
							<div class="section-title">ìƒí’ˆ êµ¬ì„± ì •ë³´</div>
							<p id="productOption"></p>
							<p id="startDeliveryDate"></p>
							<p id="dueDeliveryDate"></p>
							<p id="productPrice"></p>
						</div>

						<!-- í›„ì›ì ì •ë³´ -->
						<div class="section">
							<div class="section-title">í›„ì›ì ì •ë³´</div>
							<p id="supporterName"></p>
							<p id="supporterPhone"></p>
						</div>

						<!-- ë°°ì†¡ì§€ -->
						<div class="section">
							<div class="section-title">ë°°ì†¡ì§€</div>
							<input type="text" id="postcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly /><br />
							<input type="text" id="address" placeholder="ë°°ì†¡ì§€ ì£¼ì†Œ ì…ë ¥" readonly /><br />
							<button type="button" style="margin-top: 15px" onclick="execDaumPostcode()">
								ì£¼ì†Œ ê²€ìƒ‰
							</button>
						</div>

						<!-- ê²°ì œ ìˆ˜ë‹¨ -->
						<div class="section">
							<div class="section-title">ê²°ì œ ìˆ˜ë‹¨</div>
							<div class="checkbox-group">
								<label><input type="radio" name="pay" checked /> ì¹´ë“œ/ê°„í¸ê²°ì œ</label>
								<label><input type="radio" name="pay" /> ê³„ì¢Œì´ì²´</label>
							</div>
						</div>
					</div>

					<div class="container_1">
						<!-- ìµœì¢… í›„ì› ê¸ˆì•¡ -->
						<div class="section1">
							<div class="section-title">ìµœì¢… í›„ì› ê¸ˆì•¡</div>
							<p id="finalAmountDisplay" style="margin-bottom: 10px"></p>
							<div class="checkbox-group">
								<label><input type="checkbox" /> ê°œì¸ì •ë³´ ì œ 3ì ë™ì˜</label>
							</div>
							<button style="margin-top: 15px" onclick="submitSupport()">í›„ì›í•˜ê¸°</button>
						</div>
					</div>
				</div>
			</main>
		</div>
		<!-- ê³µí†µ í—¤ë” í‘¸í„° -->
		<script defer src="../common/header3.js"></script>
		<script defer src="../common/footer2.js"></script>

		<!-- Daum ì£¼ì†Œ ê²€ìƒ‰ -->
		<script>
			function execDaumPostcode() {
				new daum.Postcode({
					oncomplete: function (data) {
						const addr = data.roadAddress ? data.roadAddress : data.jibunAddress;
						document.getElementById('postcode').value = data.zonecode;
						document.getElementById('address').value = addr;
					},
				}).open();
			}

			window.addEventListener('DOMContentLoaded', () => {
				const data = JSON.parse(localStorage.getItem('selectedProduct')) || {};
				const supporter = JSON.parse(localStorage.getItem('loggedInUser')) || {};

				const name = supporter.name || 'ë¯¸ì…ë ¥';
				const phone = supporter.tel
					? supporter.tel.replace(/(\d{3})(\d{3,4})(\d{4})/, '$1-$2-$3')
					: 'ë¯¸ì…ë ¥';

				// ì´ë¯¸ì§€
				document.getElementById('productImage').src = data.image || '';
				// ìƒí’ˆëª…
				document.getElementById('productTitle').textContent = data.title || '';
				// ì˜µì…˜
				document.getElementById('productOption').textContent =
					`ìƒí’ˆ ì˜µì…˜: ${data.selectedOption || ''}`;
				// ì¶œê³ ì¼ & ë°°ì†¡ì¼
				if (data.estimatedDate) {
					const startDate = new Date(data.estimatedDate);
					const dueDate = new Date(startDate);
					dueDate.setDate(dueDate.getDate() + 2);

					const format = (d) => d.toISOString().slice(0, 10);

					document.getElementById('startDeliveryDate').textContent =
						`ì˜ˆìƒ ì¶œê³ ì¼: ${format(startDate)}`;
					document.getElementById('dueDeliveryDate').textContent =
						`ì˜ˆìƒ ë°°ì†¡ì¼: ${format(dueDate)}`;
				}
				// ê°€ê²©
				document.getElementById('productPrice').textContent = `ìƒí’ˆ ê°€ê²©: ${data.price || ''}ì›`;

				// í›„ì›ì ì •ë³´
				document.getElementById('supporterName').textContent = `ì´ë¦„: ${name}`;
				document.getElementById('supporterPhone').textContent = `ì—°ë½ì²˜: ${phone}`;

				// ìµœì¢… í›„ì› ê¸ˆì•¡
				document.getElementById('finalAmountDisplay').textContent =
					`ìµœì¢… í›„ì› ê¸ˆì•¡: ${data.price?.replace(/,/g, '') || ''}ì›`;
			});
			function submitSupport() {
				const agree = document.querySelector('.checkbox-group input[type="checkbox"]');
				if (!agree.checked) {
					alert('ê°œì¸ì •ë³´ ì œ 3ì ì œê³µì— ë™ì˜í•˜ì…”ì•¼ í›„ì›ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
					agree.focus();
					return;
				}

				const supporter = JSON.parse(localStorage.getItem('loggedInUser')) || {};
				// âœ… ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
				if (!supporter.id) {
					alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
					return;
				}

				const product = JSON.parse(localStorage.getItem('selectedProduct')) || {};
				const postcode = document.getElementById('postcode').value;
				const address = document.getElementById('address').value;
				// âœ… ë°°ì†¡ì§€ í•„ìˆ˜ ì…ë ¥ ì²´í¬
				if (!postcode || !address) {
					alert('ë°°ì†¡ì§€ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
					return;
				}

				const paymentMethod = document
					.querySelector('input[name="pay"]:checked')
					?.parentElement?.textContent.trim();
				const today = new Date();
				today.setHours(today.getHours() + 9); // UTC ê¸°ì¤€ ì‹œê°„ì— 9ì‹œê°„ ë”í•´ì„œ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
				const formattedDate = today.toISOString().split('T')[0]; // ë‚ ì§œ ë¶€ë¶„ë§Œ ì¶”ì¶œ (yyyy-mm-dd)
				const finalAmount = product.price?.replace(/,/g, '');

				const supportData = {
					supporter, //ìœ ì €ì •ë³´
					product,
					productId: product.productId, // productIdë¥¼ í¬í•¨
					postcode,
					address,
					paymentMethod,
					supportDate: formattedDate,
					finalAmount,
					reviewWritten: false, // âœ… ì´ ì¤„ ì¶”ê°€!
				};

				// ğŸ”¥ ìœ ì € IDë³„ë¡œ ì €ì¥ (ëˆ„ì )
				const userId = supporter.id;
				const history = JSON.parse(localStorage.getItem('supportHistory')) || {};
				if (!history[userId]) {
					history[userId] = [];
				}
				history[userId].push(supportData);
				localStorage.setItem('supportHistory', JSON.stringify(history));

				alert('í›„ì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
				window.location.href = '../mypage/mypage.html';
			}
		</script>
	</body>
</html>
