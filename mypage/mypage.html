<!doctype html>
<html lang="ko">
	<head>
		<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
		<link rel="stylesheet" href="../common/styles.css" />
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>mypage</title>
		<style>
			/* ì œëª© ì„¹ì…˜ */
			h3 {
				font-size: 25px;
				font-weight: bold;
				text-align: left;
				margin-bottom: 60px;
				color: #222;
			}

			/* ì „ì²´ ì»¨í…Œì´ë„ˆ */
			.mypage-container {
				display: flex;
				gap: 20px;
				padding: 20px;
				max-width: 1000px;
				margin: 0 auto;
			}

			/* ì¢Œì¸¡ í”„ë¡œí•„ ì„¹ì…˜ */
			.profile-section {
				width: 200px;
				padding: 20px;
				border: 1px solid #ddd;
				border-radius: 10px;
				display: flex;
				flex-direction: column;
				align-items: center;
				background-color: #f9f9f9;
			}

			/* í”„ë¡œí•„ ì´ë¯¸ì§€ */
			.profile-image {
				width: 100px;
				height: 100px;
				border-radius: 1%;
				margin-bottom: 15px;
			}

			/* í”„ë¡œí•„ ì´ë¦„ê³¼ ì´ë©”ì¼ */
			.profile-name {
				font-size: 18px;
				font-weight: bold;
				margin: 5px 0;
				color: #333;
			}

			.profile-email {
				font-size: 14px;
				color: #666;
				margin-bottom: 20px;
			}

			/* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
			.logout-button {
				background-color: #007bff;
				border: none;
				border-radius: 5px;
				padding: 10px 10px;
				color: white;
				font-size: 14px;
				cursor: pointer;
				width: 100%;
				text-align: center;
				text-decoration: none;
			}

			.logout-button:hover {
				background-color: #0056b3;
			}

			/* ìš°ì¸¡ í…Œì´ë¸” ì„¹ì…˜ */
			.tables-section {
				flex: 1;
				display: flex;
				flex-direction: column;
				gap: 20px;
			}

			/* í…Œì´ë¸” ì»¨í…Œì´ë„ˆ */
			.table-container {
				border: 1px solid #ddd;
				border-radius: 10px;
				padding: 15px;
				background-color: #f9f9f9;
			}

			/* í…Œì´ë¸” ì œëª© */
			.table-container h3 {
				font-size: 18px;
				font-weight: bold;
				margin-bottom: 10px;
				color: #333;
			}

			/* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
			.table-container table {
				width: 100%;
				border-collapse: collapse;
			}

			.table-container th,
			.table-container td {
				padding: 10px;
				text-align: left;
				font-size: 14px;
				color: #333;
			}

			.table-container th {
				background-color: #f5f5f5;
				border-bottom: 1px solid #ddd;
				font-weight: bold;
			}

			.table-container td {
				border-bottom: 1px solid #ddd;
			}

			.table-container tbody tr:last-child td {
				border-bottom: none;
			}

			/* ì²˜ë¦¬ ì¤‘ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
			.table-container td:last-child {
				color: #007bff; /* "ì²˜ë¦¬ ì¤‘" í…ìŠ¤íŠ¸ë¥¼ íŒŒë€ìƒ‰ìœ¼ë¡œ */
			}
			.review-button {
				background-color: transparent;
				border: 1px solid #007bff;
				border-radius: 5px;
				padding: 5px 10px;
				color: #007bff;
				font-size: 12px;
				text-decoration: none;
				cursor: pointer;
				float: right;
				margin-left: 0;
			}

			/* í›„ê¸° ì‘ì„± ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
			.review-button:hover {
				background-color: #007bff;
				color: white;
			}
		</style>
	</head>
	<body>
		<h3>ë§ˆì´í˜ì´ì§€</h3>
		<div class="mypage-container">
			<!-- ì¢Œì¸¡ í”„ë¡œí•„ ì„¹ì…˜ -->
			<div class="profile-section">
				<img src="../resources/profile.png" alt="Profile Image" class="profile-image" />
				<p id="profile-name" class="profile-name"></p>
				<p id="profile-tel" class="profile-tel"></p>
				<button class="logout-button">ë¡œê·¸ì•„ì›ƒ</button>
			</div>

			<!-- ìš°ì¸¡ í…Œì´ë¸” ì„¹ì…˜ -->
			<div class="tables-section">
				<!-- êµ¬ë§¤ë‚´ì—­ì •ë³´ í…Œì´ë¸” -->
				<div class="table-container">
					<h3>êµ¬ë§¤ë‚´ì—­ ì •ë³´</h3>
					<table class="purchase-table">
						<thead>
							<tr>
								<th>ë‚ ì§œ</th>
								<th>ìƒí’ˆì´ë¦„</th>
								<th>ì´ ê¸ˆì•¡</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>

				<!-- í€ë”©ì‹ ì²­ì •ë³´ í…Œì´ë¸” -->
				<div class="table-container">
					<h3>í€ë”©ì‹ ì²­ì •ë³´</h3>
					<table class="funding-table">
						<thead>
							<tr>
								<th>ë‚ ì§œ</th>
								<th>ìƒí’ˆì´ë¦„</th>
								<th>ìƒíƒœ</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>yyyy-mm-dd</td>
								<td>#####</td>
								<td>ì²˜ë¦¬ ì¤‘</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<script>
			$(document).ready(function () {
				const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
				const userId = loggedInUser?.id;

				function formatPhoneNumber(phone) {
					if (phone.length === 11) {
						return phone.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
					} else if (phone.length === 10) {
						return phone.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
					} else {
						return phone;
					}
				}

				// ìœ ì € í”„ë¡œí•„ í‘œì‹œ
				if (loggedInUser) {
					$('#profile-name').text(loggedInUser.name);
					$('#profile-tel').text(formatPhoneNumber(loggedInUser.tel));
				} else {
					$('#profile-name').text('ë¡œê·¸ì¸ í•„ìš”');
					$('#profile-tel').text('-');
				}

				// êµ¬ë§¤ë‚´ì—­
				const history = JSON.parse(localStorage.getItem('supportHistory')) || {};
				const userHistory = history[userId] || [];

				const tbody = $('.table-container').eq(0).find('tbody'); // ì²« ë²ˆì§¸ í…Œì´ë¸”
				tbody.empty(); // ê¸°ì¡´ ë¹„ìš°ê¸°

				if (userHistory.length === 0) {
					tbody.append(
						`<tr><td colspan="3" style="text-align:center;">êµ¬ë§¤ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`,
					);
				} else {
					userHistory.forEach((item) => {
						const tdContent = item.reviewWritten
							? '<span style="color: gray;">ì‘ì„± ì™„ë£Œ</span>'
							: `<a href="./review.html" class="review-button">í›„ê¸° ì‘ì„±</a>`;
						const row = `
						<tr>
							<td>${item.supportDate}</td>
							<td>${item.product.title}</td>
							<td>${Number(item.finalAmount).toLocaleString()}ì› ${tdContent}</td>
						</tr>
					`;
						tbody.append(row);
					});
				}

				// í€ë”©ì‹ ì²­ì •ë³´
				const funding = JSON.parse(localStorage.getItem('final_project_data')) || null;

				const tbody2 = $('.table-container').eq(1).find('tbody'); // ë‘ ë²ˆì§¸ í…Œì´ë¸”
				tbody2.empty(); // ğŸ‘‰ ì´ í…Œì´ë¸”ì„ ë¹„ì›Œì•¼ í•©ë‹ˆë‹¤

				if (!funding) {
					tbody2.append(
						`<tr><td colspan="3" style="text-align:center;">í€ë”©ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`,
					);
				} else {
					const row = `
		<tr>
			<td>${funding.applyDate}</td>
			<td>${funding.projectName || '(ì œëª© ì—†ìŒ)'}</td>
			<td>ì²˜ë¦¬ ì¤‘</td>
		</tr>
	`;
					tbody2.append(row);
				}

				// ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸
				$('.logout-button').click(function () {
					localStorage.removeItem('loggedInUser');
					alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
					window.location.href = '../mainpage/main.html';
				});
			});
		</script>
		<script defer src="../common/header3.js"></script>
		<script defer src="../common/footer2.js"></script>
	</body>
</html>
